<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OCR com Câmera — Página Única</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{margin:0;padding:18px;background:#f4f6f8;color:#111}
    h1{margin:0 0 8px;font-size:20px}
    p.lead{margin:6px 0 18px;color:#444}
    .layout{display:grid;grid-template-columns:1fr 360px;gap:18px}
    .card{background:white;border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(10,10,20,0.06)}
    video, canvas{width:100%;border-radius:8px;background:#000}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    button{padding:8px 10px;border-radius:8px;border:0;background:#0b5cff;color:white;cursor:pointer}
    button.secondary{background:#6c757d}
    button.danger{background:#e03131}
    label{display:inline-flex;align-items:center;gap:6px}
    textarea{width:100%;height:220px;padding:10px;border-radius:8px;border:1px solid #ddd;font-family:monospace;resize:vertical}
    .progress{height:10px;background:#e9eef6;border-radius:6px;overflow:hidden}
    .progress > i{display:block;height:100%;width:0;background:linear-gradient(90deg,#4a90e2,#2dd4bf)}
    .small{font-size:13px;color:#666}
    @media(max-width:900px){.layout{grid-template-columns:1fr} .card{padding:10px}}
  </style>
</head>
<body>
  <h1>OCR com Câmera (única página)</h1>
  <p class="lead">Abra esta página no navegador (desktop ou mobile). Permita o uso da câmera e capture uma foto para extrair texto em português.</p>

  <div class="layout">
    <div class="card">
      <div>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none"></canvas>
        <div class="controls">
          <button id="startBtn">Iniciar Câmera</button>
          <button id="snapBtn" class="secondary">Capturar</button>
          <button id="uploadBtn" class="secondary">Carregar Imagem</button>
          <input id="fileInput" type="file" accept="image/*" style="display:none" />
          <button id="ocrBtn">Executar OCR</button>
          <button id="downloadImg" class="secondary">Baixar Imagem</button>
        </div>
        <div style="margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <label><input type="checkbox" id="preproc"> Pré-processamento (binarizar)</label>
          <label class="small">Idioma: <select id="lang"><option value="por" selected>Português (por)</option><option value="eng">Inglês (eng)</option></select></label>
        </div>
        <div style="margin-top:12px">
          <div class="small">Progresso do OCR</div>
          <div class="progress"><i id="progressBar"></i></div>
          <div id="progressText" class="small">Pronto.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
        <strong>Resultado do OCR</strong>
        <button id="copyBtn" class="secondary">Copiar</button>
        <button id="clearBtn" class="danger">Limpar</button>
      </div>
      <textarea id="result" placeholder="O texto extraído aparecerá aqui..."></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="downloadTxt">Baixar .txt</button>
        <button id="openInNew" class="secondary">Abrir em nova aba</button>
      </div>
      <hr style="margin:12px 0">
      <div class="small">Dicas: Texto alinhado, boa iluminação e contraste melhoram a acurácia. Use o pré-processamento para textos escuros em fundo claro.</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script>
    // Elementos
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startBtn = document.getElementById('startBtn');
    const snapBtn = document.getElementById('snapBtn');
    const ocrBtn = document.getElementById('ocrBtn');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const result = document.getElementById('result');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const preproc = document.getElementById('preproc');
    const langSelect = document.getElementById('lang');
    const copyBtn = document.getElementById('copyBtn');
    const clearBtn = document.getElementById('clearBtn');
    const downloadTxt = document.getElementById('downloadTxt');
    const downloadImg = document.getElementById('downloadImg');
    const openInNew = document.getElementById('openInNew');

    let stream = null;
    let lastImageBlob = null;

    startBtn.onclick = async () => {
      try{
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
        video.srcObject = stream;
        startBtn.textContent = 'Câmera ativa';
      }catch(e){
        alert('Erro ao acessar a câmera: '+e.message);
      }
    }

    snapBtn.onclick = () => {
      if(!video.srcObject && !lastImageBlob){
        alert('Ative a câmera ou carregue uma imagem primeiro.');
        return;
      }
      const w = video.videoWidth || 1280;
      const h = video.videoHeight || 720;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      if(video.srcObject){
        ctx.drawImage(video,0,0,w,h);
      }
      // if preproc requested, apply filter
      if(preproc.checked){
        const imgData = ctx.getImageData(0,0,w,h);
        // simple grayscale + threshold
        for(let i=0;i<imgData.data.length;i+=4){
          const r=imgData.data[i], g=imgData.data[i+1], b=imgData.data[i+2];
          const gray = 0.299*r+0.587*g+0.114*b;
          const v = gray>150?255:0;
          imgData.data[i]=imgData.data[i+1]=imgData.data[i+2]=v;
        }
        ctx.putImageData(imgData,0,0);
      }
      canvas.style.display = 'block';
      canvas.toBlob((blob)=>{ lastImageBlob = blob; }, 'image/jpeg', 0.92);
    }

    uploadBtn.onclick = ()=> fileInput.click();
    fileInput.onchange = (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const img = new Image();
      const url = URL.createObjectURL(f);
      img.onload = ()=>{
        const w = img.naturalWidth; const h = img.naturalHeight;
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img,0,0);
        canvas.style.display = 'block';
        canvas.toBlob((blob)=>{ lastImageBlob = blob; }, 'image/jpeg', 0.92);
        URL.revokeObjectURL(url);
      }
      img.src = url;
    }

    async function runOCR(){
      if(!lastImageBlob){ alert('Capture ou carregue uma imagem primeiro.'); return; }
      result.value = '';
      progressBar.style.width = '0%';
      progressText.textContent = 'Iniciando...';

      // create a worker
      const worker = Tesseract.createWorker({
        logger: m => {
          if(m.status === 'recognizing text' && m.progress !== undefined){
            const p = Math.round(m.progress*100);
            progressBar.style.width = p+'%';
            progressText.textContent = `${m.status} — ${p}%`;
          } else if(m.status){
            progressText.textContent = m.status;
          }
        }
      });

      const selectedLang = langSelect.value || 'por';

      await worker.load();
      // carrega o idioma; Tesseract vai buscar os arquivos .traineddata automaticamente do CDN
      await worker.loadLanguage(selectedLang);
      await worker.initialize(selectedLang);

      // converter blob para dataURL para o worker
      const imgDataURL = await blobToDataURL(lastImageBlob);
      const { data: { text } } = await worker.recognize(imgDataURL);

      result.value = text.trim();
      progressBar.style.width = '100%';
      progressText.textContent = 'Concluído.';

      await worker.terminate();
    }

    ocrBtn.onclick = runOCR;

    function blobToDataURL(blob){
      return new Promise((res, rej)=>{
        const r = new FileReader();
        r.onload = ()=>res(r.result);
        r.onerror = rej;
        r.readAsDataURL(blob);
      });
    }

    copyBtn.onclick = async ()=>{
      if(!result.value){ alert('Nada para copiar.'); return; }
      try{ await navigator.clipboard.writeText(result.value); alert('Copiado para a área de transferência.'); }catch(e){ alert('Falha ao copiar: '+e.message); }
    }

    clearBtn.onclick = ()=>{ result.value=''; progressBar.style.width='0%'; progressText.textContent='Pronto.' }

    downloadTxt.onclick = ()=>{
      const blob = new Blob([result.value||''], {type:'text/plain;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ocr_result.txt';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    downloadImg.onclick = ()=>{
      if(!lastImageBlob){ alert('Nenhuma imagem para baixar.'); return; }
      const a = document.createElement('a');
      a.href = URL.createObjectURL(lastImageBlob);
      a.download = 'captura.jpg';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    openInNew.onclick = ()=>{
      const w = window.open('about:blank','_blank');
      w.document.write('<pre>'+escapeHtml(result.value||'')+'</pre>');
      w.document.title = 'Resultado OCR';
    }

    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

    // quick init: try enabling camera on load (optional)
    // navigator.mediaDevices.getUserMedia && navigator.mediaDevices.getUserMedia({video:true}).then(s=>{stream=s;video.srcObject=s}).catch(()=>{});
  </script>
</body>
</html>
