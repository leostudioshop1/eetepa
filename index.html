<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Avaliador de Reda√ß√£o ENEM com IA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">
  <header class="mb-6 text-center">
    <h1 class="text-3xl font-bold text-gray-800">Avaliador de Reda√ß√£o do ENEM</h1>
    <p class="text-gray-600">Envie sua reda√ß√£o manuscrita e receba uma avalia√ß√£o com intelig√™ncia artificial!</p>
  </header>

  <!-- Upload e C√¢mera -->
  <div class="flex gap-4 mb-8">
    <label for="file-upload" class="bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer hover:bg-blue-700 transition">
      Upload de Imagem
      <input type="file" id="file-upload" accept="image/*" class="hidden" />
    </label>
    <button id="camera-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
      Usar C√¢mera
    </button>
  </div>

  <!-- Preview -->
  <div id="preview-container" class="hidden mb-6">
    <p class="text-gray-700 font-medium mb-2">Pr√©-visualiza√ß√£o:</p>
    <img id="preview-image" class="w-80 rounded-lg shadow-md border" />
  </div>

  <!-- Status -->
  <div id="status" class="hidden mb-6 text-gray-700 font-medium"></div>

  <!-- Resultados -->
  <div id="results" class="hidden w-full max-w-4xl space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="p-4 bg-white rounded-2xl shadow-md">
        <h3 class="font-bold text-lg mb-2">Compet√™ncia 1</h3>
        <p id="c1" class="text-gray-700">-</p>
      </div>
      <div class="p-4 bg-white rounded-2xl shadow-md">
        <h3 class="font-bold text-lg mb-2">Compet√™ncia 2</h3>
        <p id="c2" class="text-gray-700">-</p>
      </div>
      <div class="p-4 bg-white rounded-2xl shadow-md">
        <h3 class="font-bold text-lg mb-2">Compet√™ncia 3</h3>
        <p id="c3" class="text-gray-700">-</p>
      </div>
      <div class="p-4 bg-white rounded-2xl shadow-md">
        <h3 class="font-bold text-lg mb-2">Compet√™ncia 4</h3>
        <p id="c4" class="text-gray-700">-</p>
      </div>
      <div class="p-4 bg-white rounded-2xl shadow-md">
        <h3 class="font-bold text-lg mb-2">Compet√™ncia 5</h3>
        <p id="c5" class="text-gray-700">-</p>
      </div>
    </div>

    <div class="p-6 bg-blue-100 rounded-2xl shadow-md text-center">
      <h2 class="text-2xl font-bold mb-2">Nota Final Estimada</h2>
      <p id="nota-final" class="text-3xl font-extrabold text-blue-700">-</p>
    </div>

    <div class="p-6 bg-white rounded-2xl shadow-md">
      <h3 class="font-bold text-lg mb-2">Sugest√µes de Melhoria</h3>
      <ul id="sugestoes" class="list-disc list-inside text-gray-700 space-y-1">
        <li>-</li>
      </ul>
    </div>
  </div>

  <!-- C√¢mera -->
  <div id="camera-container" class="hidden flex flex-col items-center mt-6">
    <video id="camera-stream" autoplay playsinline class="w-80 rounded-lg shadow-md mb-4"></video>
    <button id="capture-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
      Capturar Foto
    </button>
  </div>

  <script>
    // üî• SUA CHAVE API AQUI (cuidado ao publicar!)
    const GEMINI_API_KEY = "AIzaSyCEhugqR1xqDkxMlJdODLGetsAX9n7JoyU"; 
    const GEMINI_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent";

    const fileInput = document.getElementById('file-upload');
    const previewImage = document.getElementById('preview-image');
    const previewContainer = document.getElementById('preview-container');
    const statusDiv = document.getElementById('status');
    const results = document.getElementById('results');
    const competencias = [document.getElementById('c1'), document.getElementById('c2'), document.getElementById('c3'), document.getElementById('c4'), document.getElementById('c5')];
    const notaFinal = document.getElementById('nota-final');
    const sugestoesList = document.getElementById('sugestoes');
    const cameraBtn = document.getElementById('camera-btn');
    const cameraContainer = document.getElementById('camera-container');
    const cameraStream = document.getElementById('camera-stream');
    const captureBtn = document.getElementById('capture-btn');

    let selectedImageBase64 = "";

    fileInput.addEventListener('change', handleFile);
    cameraBtn.addEventListener('click', startCamera);
    captureBtn.addEventListener('click', captureImage);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        selectedImageBase64 = reader.result.split(",")[1];
        previewImage.src = reader.result;
        previewContainer.classList.remove('hidden');
        runOCR(reader.result);
      };
      reader.readAsDataURL(file);
    }

    async function startCamera() {
      cameraContainer.classList.remove('hidden');
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        cameraStream.srcObject = stream;
      } catch (err) {
        alert("Erro ao acessar a c√¢mera: " + err);
      }
    }

    function captureImage() {
      const canvas = document.createElement('canvas');
      canvas.width = cameraStream.videoWidth;
      canvas.height = cameraStream.videoHeight;
      canvas.getContext('2d').drawImage(cameraStream, 0, 0);
      const imgData = canvas.toDataURL('image/png');
      selectedImageBase64 = imgData.split(",")[1];
      previewImage.src = imgData;
      previewContainer.classList.remove('hidden');
      runOCR(imgData);
    }

    async function runOCR(imgData) {
      statusDiv.textContent = "üîç Reconhecendo texto (OCR)...";
      statusDiv.classList.remove('hidden');

      const result = await Tesseract.recognize(imgData, 'por', { logger: m => console.log(m) });
      const text = result.data.text.trim();

      if (text.length < 30) {
        alert("N√£o foi poss√≠vel reconhecer corretamente a reda√ß√£o. Tente outra foto.");
        statusDiv.classList.add('hidden');
        return;
      }

      console.log("Texto OCR:", text);
      evaluateEssay(text);
    }

    async function evaluateEssay(text) {
      statusDiv.textContent = "ü§ñ Avaliando reda√ß√£o com IA...";

      const prompt = `
Voc√™ √© um avaliador oficial do ENEM. Avalie o seguinte texto extra√≠do de uma reda√ß√£o manuscrita:
---
${text}
---
Regras:
1. Avalie com base nas 5 compet√™ncias do ENEM (0 a 200 cada).
2. D√™ nota 0 se houver fuga de tema.
3. Sugira melhorias detalhadas.
Responda apenas em JSON:
{
  "competencias": [c1, c2, c3, c4, c5],
  "nota_final": total,
  "sugestoes": ["sugest√£o 1", "sugest√£o 2", ...]
}`;

      const res = await fetch(`${GEMINI_URL}?key=${GEMINI_API_KEY}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      });

      const data = await res.json();
      const textResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "";

      try {
        const parsed = JSON.parse(textResponse);
        competencias.forEach((el, i) => el.textContent = parsed.competencias[i]);
        notaFinal.textContent = parsed.nota_final;
        sugestoesList.innerHTML = parsed.sugestoes.map(s => `<li>${s}</li>`).join('');
        results.classList.remove('hidden');
      } catch (err) {
        alert("Erro na resposta da IA. Veja console.");
        console.log(textResponse);
      }

      statusDiv.classList.add('hidden');
    }
  </script>
</body>
</html>
